<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能記事生成機</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <style>

        /* ... CSSスタイルは変更なし ... */

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        #editor {
            outline: none;
            border: 1px solid #4b5563;
            padding: 1.5rem;
            border-radius: 0 0 0.5rem 0.5rem; /* 角丸を調整 */
            background-color: #1f2937;
            color: #f9fafb;
            min-height: 400px;
            line-height: 1.7;
            transition: padding-top 0.2s ease-in-out; /* パディング変化を滑らかに */
        }
        #editor:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            color: #d1d5db;
            background-color: #374151;
            transition: transform 0.1s ease-in-out, background-color 0.15s ease-in-out;
            position: relative;
        }
        .toolbar-btn:hover {
            background-color: #4b5563;
            color: #ffffff;
        }
        .toolbar-btn:active {
            transform: scale(0.95);
            background-color: #1f2937;
        }
        #editor > * {
            position: relative;
            padding: 1rem 0.75rem 0.75rem;
            margin: 0.5rem 0;
            border: 1px dashed #4b5563;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        #editor > *:hover {
            border-color: #6b7280;
            background-color: rgba(55, 65, 81, 0.5);
        }
        #editor > *::before {
            position: absolute; top: -1px; left: -1px; padding: 0.125rem 0.5rem; font-size: 0.75rem; font-weight: 600;
            border-radius: 0.375rem 0 0.375rem 0; color: white;
        }
        #editor h1::before { content: 'タイトル'; background-color: #7c3aed; }
        #editor h2::before { content: '見出し'; background-color: #1d4ed8; }
        #editor h3::before { content: '小見出し'; background-color: #0d9488; }
        #editor p::before { content: '本文'; background-color: #64748b; }
        #editor img { padding-top: 2rem !important; }
        #editor img::before { content: '画像'; background-color: #c2410c; }
        #editor [data-embed-wrapper]::before { content: '埋め込み'; background-color: #4f46e5; }
        #editor b, #editor strong { color: #ffffff; }
        #editor a { color: #fde047; text-decoration: underline; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; }
        #color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        #toolbar-wrapper.fixed {
            position: fixed;
            top: 1rem; /* 画面上部からの余白 */
            z-index: 50;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            animation: fadeInDown 0.3s ease-out;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-100">高機能記事生成機</h1>
            <p class="text-gray-400 mt-2">楽に記事生成（データは自動でブラウザに保存されます）</p>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h2 class="text-xl font-semibold mb-3 text-gray-300">エディタ</h2>
                <div id="toolbar-wrapper">
                    <div id="toolbar" class="flex flex-wrap gap-2 border border-b-0 border-gray-600 bg-gray-700 p-3 rounded-t-lg">
                        <button class="toolbar-btn" onclick="applyBlockStyle('h1')" title="タイトル (H1)"><i data-lucide="heading-1"></i></button>
                        <button class="toolbar-btn" onclick="applyBlockStyle('h2')" title="見出し (H2)"><i data-lucide="heading-2"></i></button>
                        <button class="toolbar-btn" onclick="applyBlockStyle('h3')" title="小見出し (H3)"><i data-lucide="heading-3"></i></button>
                        <button class="toolbar-btn" onclick="applyBlockStyle('p')" title="本文に変更"><i data-lucide="pilcrow"></i></button>
                        <button class="toolbar-btn" onclick="addNewTextBox()" title="新しいテキストボックスを追加"><i data-lucide="square-plus"></i></button>
                        <button class="toolbar-btn" onclick="applyInlineStyle('bold')" title="太字"><i data-lucide="bold"></i></button>

                        <button class="toolbar-btn" title="文字色">
                            <i data-lucide="highlighter"></i>
                            <input id="color-picker-input" type="color" onchange="changeTextColor(this.value)">
                        </button>
                        <div class="toolbar-btn relative" title="フォントを変更">
                            <i data-lucide="case-sensitive"></i>
                            <select onchange="changeFont(this.value)" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                                <option value="Inter, 'Noto Sans JP', sans-serif">デフォルト</option>
                                <option value="serif">明朝体</option>
                                <option value="monospace">ゴシック体</option>
                                <option value="'MS PMincho', 'Hiragino Mincho ProN', serif">MS P明朝</option>
                                <option value="'MS PGothic', 'Hiragino Kaku Gothic ProN', sans-serif">MS Pゴシック</option>
                            </select>
                        </div>
                        <button class="toolbar-btn" onclick="insertImage()" title="画像を挿入"><i data-lucide="image"></i></button>
                        <button class="toolbar-btn" onclick="showIframeModal()" title="URLやコードを埋め込む"><i data-lucide="code-2"></i></button>

                        <button class="toolbar-btn" onclick="createLink()" title="リンクを作成"><i data-lucide="link"></i></button>
                    </div>
                    <div id="toolbar-feedback" class="h-6 text-sm text-blue-400 p-2 bg-gray-700 border-x border-gray-600"></div>
                </div>
                <div id="editor" contenteditable="true" oninput="onEditorInput()">
                    <h1>記事のタイトル</h1>
                    <p>ここに本文を入力します。テキストを選択して、上のツールバーからスタイルを適用してください。</p>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-3 text-gray-300">リアルタイムプレビュー</h2>
                <div id="preview-wrapper" class="border border-gray-600 rounded-lg shadow-sm overflow-hidden bg-gray-900">
                     <iframe id="preview" class="w-full h-[500px]" style="transition: height 0.3s ease;"></iframe>
                </div>
            </div>
        </div>
        <div class="mt-12">
            <h2 class="text-2xl font-semibold mb-4 text-gray-200">記事の出力と管理</h2>
             <div class="flex flex-wrap items-center gap-4 mb-4">
                <button onclick="generateHtml()" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors active:scale-95">
                    目次を生成してコードを更新
                </button>
                 <button onclick="copyToClipboard()" class="flex items-center gap-2 px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors active:scale-95">
                    <i data-lucide="clipboard"></i><span>コードをコピー</span>
                </button>
                <button onclick="exportData()" class="flex items-center gap-2 px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors active:scale-95">
                    <i data-lucide="download"></i><span>データをエクスポート</span>
                </button>
                 <button onclick="document.getElementById('import-file').click()" class="flex items-center gap-2 px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors active:scale-95">
                    <i data-lucide="upload"></i><span>データをインポート</span>
                </button>
                <input type="file" id="import-file" accept=".txt" style="display:none;">
            </div>
            <textarea id="output-code" class="w-full h-64 p-4 border border-gray-600 rounded-lg font-mono text-sm bg-gray-900 text-green-400" readonly></textarea>
            <p id="copy-feedback" class="text-green-500 mt-2 h-5"></p>
        </div>
    </div>

    <div id="iframe-modal" class="modal"><div class="modal-content">
        <h3 class="text-lg font-semibold text-gray-100 mb-4">埋め込みコンテンツの追加</h3>
        <div class="mb-4">
            <label class="block text-gray-300 mb-2">URLまたは埋め込みコード</label>
            <textarea id="iframe-input" class="w-full p-2 bg-gray-700 text-gray-100 rounded" rows="4" placeholder="https://example.com または &lt;iframe&gt;&lt;/iframe&gt;"></textarea>
        </div>
        <div class="flex justify-end gap-2">
            <button onclick="hideIframeModal()" class="px-4 py-2 bg-gray-600 text-white rounded">キャンセル</button>
            <button onclick="insertIframe()" class="px-4 py-2 bg-blue-600 text-white rounded">埋め込む</button>
        </div>
    </div></div>
    
    <input type="file" id="image-upload" accept="image/*" style="display: none;">
    
    <script>
        // ... JavaScriptは変更なし ...
        const editor = document.getElementById('editor');
        const previewFrame = document.getElementById('preview');
        const outputCode = document.getElementById('output-code');
        const feedbackEl = document.getElementById('toolbar-feedback');
        const imageUpload = document.getElementById('image-upload');
        const importFile = document.getElementById('import-file');
        const iframeModal = document.getElementById('iframe-modal');
        const iframeInput = document.getElementById('iframe-input');
        
        let feedbackTimeout;
        let saveTimeout;
        let savedRange = null; 

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.execCommand("defaultParagraphSeparator", false, "p");
            
            loadData(); 
            
            editor.addEventListener('keydown', handleEnterKey);
            imageUpload.addEventListener('change', handleImageUpload);
            importFile.addEventListener('change', handleImport);
                        editor.addEventListener('paste', (event) => {
                // デフォルトのペースト処理をキャンセル
                event.preventDefault(); 
                
                // クリップボードからプレーンテキストを取得
                const text = (event.clipboardData || window.clipboardData).getData('text/plain');
                
                // 取得したテキストをカーソル位置に挿入
                document.execCommand('insertText', false, text);
            });
            updatePreview();
            generateHtml();

            setupStickyToolbar();
        });


        // --- ツールバー固定機能 ---
        function setupStickyToolbar() {
            const toolbarWrapper = document.getElementById('toolbar-wrapper');
            if (!toolbarWrapper) return;

            const toolbarOriginalOffsetTop = toolbarWrapper.offsetTop;

            window.addEventListener('scroll', () => {
                const parentRect = toolbarWrapper.parentElement.getBoundingClientRect();

                if (window.scrollY > toolbarOriginalOffsetTop) {
                    if (!toolbarWrapper.classList.contains('fixed')) {
                        const wrapperRect = toolbarWrapper.getBoundingClientRect();
                        toolbarWrapper.style.width = `${wrapperRect.width}px`;
                        editor.style.paddingTop = `${wrapperRect.height}px`;
                        toolbarWrapper.classList.add('fixed');
                    }
                } else {
                    if (toolbarWrapper.classList.contains('fixed')) {
                        toolbarWrapper.classList.remove('fixed');
                        toolbarWrapper.style.width = '';
                        editor.style.paddingTop = '';
                    }
                }
            }, { passive: true });
        }


        // --- データ管理 (保存/読込/入出力) ---
        function onEditorInput() {
            updatePreview();
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        }
        
        function saveData() {
            localStorage.setItem('editorContent', editor.innerHTML);
            showFeedback('自動保存しました', false);
        }

        function loadData() {
            const savedContent = localStorage.getItem('editorContent');
            if (savedContent) {
                editor.innerHTML = savedContent;
                showFeedback('保存されたデータを読み込みました', false);
            }
        }

        function exportData() {
            const data = editor.innerHTML;
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'article-data.txt';
            a.click();
            URL.revokeObjectURL(url);
            showFeedback('データをエクスポートしました', false);
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                editor.innerHTML = e.target.result;
                onEditorInput();
                generateHtml();
                showFeedback('データをインポートしました', false);
            };
            reader.readAsText(file);
            event.target.value = '';
        }


        // --- エディタ操作 ---
        function getBlockElementFromRange(range) {
            if (!range) return null;
            let element = range.startContainer;
            if (element.nodeType === Node.TEXT_NODE) element = element.parentElement;
            return element.closest('#editor > *');
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                document.execCommand('insertParagraph');
            }
        }
        
        function showFeedback(message, isError = false) {
            clearTimeout(feedbackTimeout);
            feedbackEl.textContent = message;
            feedbackEl.className = `h-6 text-sm p-2 bg-gray-700 border-x border-gray-600 ${isError ? 'text-red-400' : 'text-blue-400'}`;
            feedbackTimeout = setTimeout(() => { feedbackEl.textContent = ''; }, 3000);
        }
        
        function applyBlockStyle(tagName) {
            document.execCommand('formatBlock', false, `<${tagName}>`);
            onEditorInput();
        }

        function applyInlineStyle(style) {
            document.execCommand(style);
            editor.focus();
            onEditorInput();
        }

        function changeTextColor(color) {
            if(color) {
                document.execCommand('foreColor', false, color);
                showFeedback('文字色を変更しました。');
                editor.focus();
                onEditorInput();
            }
        }

        function changeFont(font) {
            if(font) {
                document.execCommand('fontName', false, font);
                showFeedback('フォントを変更しました。');
                editor.focus();
                onEditorInput();
            }
        }

        function createLink() {
            const url = prompt('リンク先のURLを入力してください:', 'https://');

            if (url) {
                document.execCommand('createLink', false, url);
                onEditorInput();
            }
        }

        function addNewTextBox() {
            document.execCommand('insertParagraph');
            onEditorInput();
        }

        // --- 画像 & 埋め込み ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.execCommand('insertImage', false, e.target.result);
                onEditorInput();
            };
            reader.readAsDataURL(file);
        }
        
        function insertImage() {
            imageUpload.click();
        }

        function showIframeModal() {
            if (window.getSelection().rangeCount > 0) {
                savedRange = window.getSelection().getRangeAt(0).cloneRange();
            }
            iframeInput.value = '';
            iframeModal.style.display = 'flex';
        }

        function hideIframeModal() {
            iframeModal.style.display = 'none';
        }

        function insertIframe() {
            const input = iframeInput.value.trim();
            if (!input) return;

            let embedHtml = '';
            if (input.startsWith('<iframe')) {
                embedHtml = input;
            } else if (input.startsWith('http')) {
                embedHtml = `<iframe src="${input}" style="width:100%; height:450px; border:0;" allowfullscreen="" loading="lazy"></iframe>`;
            } else {
                return showFeedback('不正なURLまたはコードです', true);
            }

            const wrapper = document.createElement('div');
            wrapper.dataset.embedWrapper = true;
            wrapper.innerHTML = embedHtml;
            
            const currentBlock = getBlockElementFromRange(savedRange);
            if (currentBlock) {
                currentBlock.after(wrapper);
            } else {
                editor.appendChild(wrapper); 
            }
            
            hideIframeModal();
            onEditorInput();
        }


        // --- HTML生成 & プレビュー ---

        function updatePreview() {
            let content = editor.innerHTML;
            content = content.replace(/<font face="([^"]+)">/g, '<span style="font-family:$1;">').replace(/<font color="([^"]+)">/g, '<span style="color:$1;">').replace(/<\/font>/g, '</span>');

            const previewDoc = previewFrame.contentDocument;
            const previewStyles = `

                h1,h2,h3 { margin-top: 1.5em; margin-bottom: 0.75em; font-weight: bold; }
                h1 { font-size: 2.25em; border-bottom: 2px solid #374151; padding-bottom: 0.25em; }
                h2 { font-size: 1.875em; border-bottom: 1px solid #374151; padding-bottom: 0.25em; }
                h3 { font-size: 1.5em; }
                p { margin-bottom: 1em; min-height: 1em; }
                b, strong { font-weight: bold; color: #ffffff; }
                img, iframe { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1em 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                iframe { width: 100%; min-height: 450px; border: 1px solid #4b5563; }
                a { color: #fde047; text-decoration: underline; }

                .toc { background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; }
                .toc h2 { font-size: 1.25em; margin-top: 0; margin-bottom: 1rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem; color: #e5e7eb; }
                .toc ul { list-style-type: none; padding: 0; } .toc ul ul { padding-left: 1.5rem; margin-top: 0.5rem; }
                .toc a { text-decoration: none; color: #d1d5db; } .toc a:hover { text-decoration: underline; color: #ffffff; }

            `;
            previewDoc.open();
            previewDoc.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>プレビュー</title>
                <style>body { font-family: 'Inter', 'Noto Sans JP', sans-serif; line-height: 1.7; margin: 2rem; background-color: #111827; color: #d1d5db; overflow: hidden; } ${previewStyles}</style>
                <script>
                MathJax = {
                  tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']]
                  }
                };
                <\/script>
                <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
                </head><body><div class="preview-content">${content}</div></body></html>`);
            previewDoc.close();
            
            previewFrame.onload = () => {
                const adjustHeight = () => {
                    const contentHeight = previewFrame.contentDocument.body.scrollHeight;
                    previewFrame.style.height = `${Math.max(contentHeight + 20, 400)}px`;
                };

                if (previewFrame.contentWindow && previewFrame.contentWindow.MathJax) {
                    previewFrame.contentWindow.MathJax.typesetPromise()
                        .then(adjustHeight)
                        .catch((err) => console.error(err));
                } else {
                    setTimeout(adjustHeight, 50);
                }
            };
        }


        
        function generateToc(content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const headers = tempDiv.querySelectorAll('h1, h2, h3');
            if (headers.length < 2) return { tocHtml: '', contentWithIds: content };
            let toc = '<div class="toc"><h2>目次</h2><ul>';
            let level = 0;
            headers.forEach((h, i) => {
                if(!h.textContent.trim()) return;
                const newLevel = parseInt(h.tagName.substring(1), 10);
                const id = `toc-${i}`;
                h.id = id;
                if (newLevel > level) toc += '<ul>'.repeat(newLevel - level);
                else if (newLevel < level) toc += '</ul>'.repeat(level - newLevel);
                toc += `<li><a href="#${id}">${h.textContent}</a></li>`;
                level = newLevel;
            });
            toc += '</ul>'.repeat(level) + '</div>';
            return { tocHtml: toc, contentWithIds: tempDiv.innerHTML };
        }

        function generateHtml() {
            let content = editor.innerHTML;
            content = content.replace(/<font color="([^"]+)">/g, '<span style="color:$1;">').replace(/<\/font>/g, '</span>');

            const { tocHtml, contentWithIds } = generateToc(content);
            const title = editor.querySelector('h1')?.textContent || '無題の記事';

            const finalHtml = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${title}</title>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
<style>
body{font-family:system-ui,sans-serif;line-height:1.7;margin:0 auto;max-width:800px;padding:20px;background-color:#111827;color:#d1d5db}h1,h2,h3{margin-top:1.5em;margin-bottom:.75em;font-weight:700}h1{font-size:2.25em;border-bottom:2px solid #374151;padding-bottom:.25em}h2{font-size:1.875em;border-bottom:1px solid #374151;padding-bottom:.25em}h3{font-size:1.5em}p{margin-bottom:1em}b,strong{font-weight:700;color:#ffffff}img,iframe{max-width:100%;height:auto;border-radius:.5rem;margin:1em 0;box-shadow:0 4px 6px rgba(0,0,0,.1)}iframe{width:100%;min-height:450px;border:1px solid #4b5563}ul,ol{padding-left:1.5em;margin-bottom:1em}a{color:#fde047;text-decoration:underline}.toc{background-color:#1f2937;border:1px solid #4b5563;border-radius:.75rem;padding:1.5rem;margin-bottom:2rem}.toc h2{font-size:1.25em;margin-top:0;margin-bottom:1rem;border-bottom:1px solid #4b5563;padding-bottom:.5rem;color:#e5e7eb}.toc ul{list-style-type:none;padding-left:0}.toc ul ul{padding-left:1.5rem;margin-top:.5rem}.toc a{text-decoration:none;color:#d1d5db}.toc a:hover{text-decoration:underline;color:#fff}
</style></head><body>

    ${tocHtml}
    ${contentWithIds}

</body></html>`;
            outputCode.value = finalHtml;
            updatePreview();
        }

        function copyToClipboard() {
            outputCode.select();
            document.execCommand('copy');
            const feedback = document.getElementById('copy-feedback');
            feedback.textContent = 'コピーしました！';
            setTimeout(() => { feedback.textContent = ''; }, 2000);
        }
        
        setInterval(() => { lucide.createIcons(); }, 2000);
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('サービスワーカーの登録に成功しました: ', registration.scope);
          }, err => {
            console.log('サービスワーカーの登録に失敗しました: ', err);
          });
        });
      }
    </script>
    </body>
</html>
